<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Rafael A. Irizarry">
<title>16&nbsp; String processing – Introduction to Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../wrangling/text-analysis.html" rel="next">
<link href="../wrangling/web-scraping.html" rel="prev">
<link href="../cover.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-314d552717907458410b1a40a915f399.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../wrangling/intro-to-wrangling.html">Data Wrangling</a></li><li class="breadcrumb-item"><a href="../wrangling/string-processing.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">String processing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Introduction to Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/rafalab/dsbook-part-1" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../R/intro-to-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../R/getting-started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../R/R-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">R basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../R/programming-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Programming basics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../R/tidyverse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The tidyverse</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../R/data-table.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">data.table</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../R/importing-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Importing data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../dataviz/intro-dataviz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Visualization</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dataviz/distributions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Visualizing data distributions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dataviz/ggplot2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">ggplot2</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dataviz/dataviz-principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Data visualization principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../dataviz/dataviz-in-practice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Data visualization in practice</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../wrangling/intro-to-wrangling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Wrangling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wrangling/reshaping-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Reshaping data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wrangling/joining-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Joining tables</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wrangling/dates-and-times.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Parsing dates and times</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wrangling/locales.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Locales</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wrangling/web-scraping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Extracting data from the web</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wrangling/string-processing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">String processing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../wrangling/text-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Text analysis</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../productivity/intro-productivity.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Productivity Tools</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../productivity/unix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Organizing with Unix</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../productivity/git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Git and GitHub</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../productivity/reproducible-projects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Reproducible projects</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-stringr" id="toc-sec-stringr" class="nav-link active" data-scroll-target="#sec-stringr"><span class="header-section-number">16.1</span> The stringr package</a></li>
  <li><a href="#case-study-1-self-reported-heights" id="toc-case-study-1-self-reported-heights" class="nav-link" data-scroll-target="#case-study-1-self-reported-heights"><span class="header-section-number">16.2</span> Case study 1: self-reported heights</a></li>
  <li><a href="#escaping" id="toc-escaping" class="nav-link" data-scroll-target="#escaping"><span class="header-section-number">16.3</span> Escaping</a></li>
  <li>
<a href="#sec-regex" id="toc-sec-regex" class="nav-link" data-scroll-target="#sec-regex"><span class="header-section-number">16.4</span> Regular expressions</a>
  <ul class="collapse">
<li><a href="#strings-are-a-regex" id="toc-strings-are-a-regex" class="nav-link" data-scroll-target="#strings-are-a-regex"><span class="header-section-number">16.4.1</span> Strings are a regex</a></li>
  <li><a href="#special-characters" id="toc-special-characters" class="nav-link" data-scroll-target="#special-characters"><span class="header-section-number">16.4.2</span> Special characters</a></li>
  <li><a href="#character-classes" id="toc-character-classes" class="nav-link" data-scroll-target="#character-classes"><span class="header-section-number">16.4.3</span> Character classes</a></li>
  <li><a href="#anchors" id="toc-anchors" class="nav-link" data-scroll-target="#anchors"><span class="header-section-number">16.4.4</span> Anchors</a></li>
  <li><a href="#bounded-quantifiers" id="toc-bounded-quantifiers" class="nav-link" data-scroll-target="#bounded-quantifiers"><span class="header-section-number">16.4.5</span> Bounded quantifiers</a></li>
  <li><a href="#white-space" id="toc-white-space" class="nav-link" data-scroll-target="#white-space"><span class="header-section-number">16.4.6</span> White space</a></li>
  <li><a href="#unbounded-quantifiers" id="toc-unbounded-quantifiers" class="nav-link" data-scroll-target="#unbounded-quantifiers"><span class="header-section-number">16.4.7</span> Unbounded quantifiers: <code>*</code>, <code>?</code>, <code>+</code></a></li>
  <li><a href="#not" id="toc-not" class="nav-link" data-scroll-target="#not"><span class="header-section-number">16.4.8</span> Not</a></li>
  <li><a href="#sec-groups" id="toc-sec-groups" class="nav-link" data-scroll-target="#sec-groups"><span class="header-section-number">16.4.9</span> Groups</a></li>
  <li><a href="#search-and-replace" id="toc-search-and-replace" class="nav-link" data-scroll-target="#search-and-replace"><span class="header-section-number">16.4.10</span> Search and replace</a></li>
  <li><a href="#search-and-replace-using-groups" id="toc-search-and-replace-using-groups" class="nav-link" data-scroll-target="#search-and-replace-using-groups"><span class="header-section-number">16.4.11</span> Search and replace using groups</a></li>
  <li><a href="#lookarounds" id="toc-lookarounds" class="nav-link" data-scroll-target="#lookarounds"><span class="header-section-number">16.4.12</span> Lookarounds</a></li>
  <li><a href="#sec-separate_regex" id="toc-sec-separate_regex" class="nav-link" data-scroll-target="#sec-separate_regex"><span class="header-section-number">16.4.13</span> Separating variables</a></li>
  </ul>
</li>
  <li><a href="#trimming" id="toc-trimming" class="nav-link" data-scroll-target="#trimming"><span class="header-section-number">16.5</span> Trimming</a></li>
  <li><a href="#case-conversion" id="toc-case-conversion" class="nav-link" data-scroll-target="#case-conversion"><span class="header-section-number">16.6</span> Case conversion</a></li>
  <li><a href="#case-study-1-continued-putting-it-all-together" id="toc-case-study-1-continued-putting-it-all-together" class="nav-link" data-scroll-target="#case-study-1-continued-putting-it-all-together"><span class="header-section-number">16.7</span> Case study 1 continued: Putting it all together</a></li>
  <li><a href="#case-study-2-extracting-tables-from-a-pdf" id="toc-case-study-2-extracting-tables-from-a-pdf" class="nav-link" data-scroll-target="#case-study-2-extracting-tables-from-a-pdf"><span class="header-section-number">16.8</span> Case study 2: extracting tables from a PDF</a></li>
  <li><a href="#sec-recode" id="toc-sec-recode" class="nav-link" data-scroll-target="#sec-recode"><span class="header-section-number">16.9</span> Renaming levels</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">16.10</span> Exercises</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/rafalab/dsbook-part-1/blob/main/wrangling/string-processing.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/rafalab/dsbook-part-1/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../wrangling/intro-to-wrangling.html">Data Wrangling</a></li><li class="breadcrumb-item"><a href="../wrangling/string-processing.html"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">String processing</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">16</span>&nbsp; <span class="chapter-title">String processing</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>One of the most common data wrangling challenges involves extracting numeric data contained in character strings and converting them into the numeric representations required to make plots, compute summaries, or fit models in R. Also common is processing unorganized text into meaningful variable names or categorical variables. Many of the string processing challenges a data scientist faces are unique and often unexpected. It is therefore quite ambitious to write a comprehensive section on this topic. Here we use a series of case studies that help us demonstrate how string processing is a necessary step for many data wrangling challenges. Specifically, we describe the process of converting the original, <em>raw</em> data from which we extracted the <code>murders</code>, <code>heights</code>, and <code>research_funding_rates</code> examples into the data frames we have studied in this book.</p>
<p>By going over these case studies, we will cover some of the most common tasks in string processing including extracting numbers from strings, removing unwanted characters from text, finding and replacing characters, extracting specific parts of strings, converting free form text to more uniform formats, and splitting strings into multiple values.</p>
<p>Base R includes functions to perform many of these tasks. The <strong>stringi</strong> package adds significant functionality over what is available in base R, especially for complex and diverse text processing needs. The <strong>stringr</strong> package provides consistent, simple, and user friendly wrappers around the <strong>stringi</strong> package. For example, in <strong>stringr</strong>, all the string processing functions start with <code>str_</code>. This means that if you type <code>str_</code> and hit tab, R will auto-complete and show all the available functions. As a result, we don’t necessarily have to memorize all the function names. Another advantage is that in the functions in this package the string being processed is always the first argument, which means we can more easily use the pipe. Therefore, we will start by describing how to use the functions in the <strong>stringr</strong> package.</p>
<p>Most of the examples will come from the second case study which deals with self-reported heights by students, and most of the chapter is dedicated to learning regular expressions (regex) and functions in the <strong>stringr</strong> package.</p>
<section id="sec-stringr" class="level2" data-number="16.1"><h2 data-number="16.1" class="anchored" data-anchor-id="sec-stringr">
<span class="header-section-number">16.1</span> The stringr package</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In general, string processing tasks can be divided into <strong>detecting</strong>, <strong>locating</strong>, <strong>extracting</strong>, or <strong>replacing</strong> patterns in strings. We will see several examples. The table below includes the functions available to you in the <strong>stringr</strong> package. We split them by task. We also include the base R equivalent when available.</p>
<p>All these functions take a character vector as first argument. Also, for each function, operations are vectorized: the operation gets applied to each string in the vector.</p>
<p>Finally, we mention <em>groups</em> in this table. These will be explained in <a href="#sec-groups" class="quarto-xref"><span>Section 16.4.9</span></a>.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 19%">
<col style="width: 19%">
<col style="width: 42%">
<col style="width: 19%">
</colgroup>
<thead><tr class="header">
<th>stringr</th>
<th>Task</th>
<th>Description</th>
<th>Base R</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>str_detect</code></td>
<td>Detect</td>
<td>Is the pattern in the string?</td>
<td><code>grepl</code></td>
</tr>
<tr class="even">
<td><code>str_which</code></td>
<td>Detect</td>
<td>Returns the index of entries that contain the pattern.</td>
<td><code>grep</code></td>
</tr>
<tr class="odd">
<td><code>str_subset</code></td>
<td>Detect</td>
<td>Returns the subset of strings that contain the pattern.</td>
<td>
<code>grep</code> with <code>value = TRUE</code>
</td>
</tr>
<tr class="even">
<td><code>str_locate</code></td>
<td>Locate</td>
<td>Returns positions of first occurrence of the pattern in a string.</td>
<td><code>regexpr</code></td>
</tr>
<tr class="odd">
<td><code>str_locate_all</code></td>
<td>Locate</td>
<td>Returns position of all occurrences of the pattern in a string.</td>
<td><code>gregexpr</code></td>
</tr>
<tr class="even">
<td><code>str_view</code></td>
<td>Locate</td>
<td>Show the first part of the string that matches the pattern.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>str_view_all</code></td>
<td>Locate</td>
<td>Show all the parts of the string that match the pattern.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_extract</code></td>
<td>Extract</td>
<td>Extract the first part of the string that matches the pattern.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>str_extract_all</code></td>
<td>Extract</td>
<td>Extract all parts of the string that match the pattern.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_match</code></td>
<td>Extract</td>
<td>Extract first part of the string that matches the pattern and the groups defined by the pattern.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>str_match_all</code></td>
<td>Extract</td>
<td>Extract all parts of the string that match the pattern and the groups defined by the pattern.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_sub</code></td>
<td>Extract</td>
<td>Extract a substring.</td>
<td><code>substring</code></td>
</tr>
<tr class="odd">
<td><code>str_split</code></td>
<td>Extract</td>
<td>Split a string into a list with parts separated by a pattern.</td>
<td><code>strsplit</code></td>
</tr>
<tr class="even">
<td><code>str_split_fixed</code></td>
<td>Extract</td>
<td>Split a string into a matrix with a fixed number of parts separated by a pattern.</td>
<td>
<code>strsplit</code> with <code>fixed = TRUE</code>
</td>
</tr>
<tr class="odd">
<td><code>str_count</code></td>
<td>Describe</td>
<td>Count number of times a pattern appears in a string.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_length</code></td>
<td>Describe</td>
<td>Number of character in string.</td>
<td><code>nchar</code></td>
</tr>
<tr class="odd">
<td><code>str_replace</code></td>
<td>Replace</td>
<td>Replace first part of a string matching a pattern with another.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_replace_all</code></td>
<td>Replace</td>
<td>Replace all parts of a string matching a pattern with another.</td>
<td><code>gsub</code></td>
</tr>
<tr class="odd">
<td><code>str_to_upper</code></td>
<td>Replace</td>
<td>Change all characters to upper case.</td>
<td><code>toupper</code></td>
</tr>
<tr class="even">
<td><code>str_to_lower</code></td>
<td>Replace</td>
<td>Change all characters to lower case.</td>
<td><code>tolower</code></td>
</tr>
<tr class="odd">
<td><code>str_to_title</code></td>
<td>Replace</td>
<td>Change first character of each word to upper and rest to lower case.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_replace_na</code></td>
<td>Replace</td>
<td>Replace all <code>NA</code>s with a new value.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>str_trim</code></td>
<td>Replace</td>
<td>Remove white space from start and end of string.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_c</code></td>
<td>Manipulate</td>
<td>Join multiple strings.</td>
<td><code>paste0</code></td>
</tr>
<tr class="odd">
<td><code>str_conv</code></td>
<td>Manipulate</td>
<td>Change the encoding of the string.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_sort</code></td>
<td>Manipulate</td>
<td>Sort the vector in alphabetical order.</td>
<td><code>sort</code></td>
</tr>
<tr class="odd">
<td><code>str_order</code></td>
<td>Manipulate</td>
<td>Provide index needed to order the vector in alphabetical order.</td>
<td><code>order</code></td>
</tr>
<tr class="even">
<td><code>str_trunc</code></td>
<td>Manipulate</td>
<td>Truncate a string to a fixed size.</td>
<td></td>
</tr>
<tr class="odd">
<td><code>str_pad</code></td>
<td>Manipulate</td>
<td>Add white space to string to make it a fixed size.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_dup</code></td>
<td>Manipulate</td>
<td>Repeat a string.</td>
<td>
<code>rep</code> then <code>paste</code>
</td>
</tr>
<tr class="odd">
<td><code>str_wrap</code></td>
<td>Manipulate</td>
<td>Wrap things into formatted paragraphs.</td>
<td></td>
</tr>
<tr class="even">
<td><code>str_interp</code></td>
<td>Manipulate</td>
<td>String interpolation.</td>
<td><code>sprintf</code></td>
</tr>
</tbody>
</table></section><section id="case-study-1-self-reported-heights" class="level2" data-number="16.2"><h2 data-number="16.2" class="anchored" data-anchor-id="case-study-1-self-reported-heights">
<span class="header-section-number">16.2</span> Case study 1: self-reported heights</h2>
<p>The <strong>dslabs</strong> package includes the raw data from which the heights dataset was obtained. You can load it like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dslabs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">reported_heights</span><span class="op">)</span></span>
<span><span class="co">#&gt;            time_stamp    sex height</span></span>
<span><span class="co">#&gt; 1 2014-09-02 13:40:36   Male     75</span></span>
<span><span class="co">#&gt; 2 2014-09-02 13:46:59   Male     70</span></span>
<span><span class="co">#&gt; 3 2014-09-02 13:59:20   Male     68</span></span>
<span><span class="co">#&gt; 4 2014-09-02 14:51:53   Male     74</span></span>
<span><span class="co">#&gt; 5 2014-09-02 15:16:15   Male     61</span></span>
<span><span class="co">#&gt; 6 2014-09-02 15:16:16 Female     65</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These heights were obtained using a web form in which students were asked to enter their heights. They could enter anything, but the instructions asked for <em>height in inches</em>, a number. We compiled 1,095 submissions, but unfortunately the column vector with the reported heights had several non-numeric entries and as a result became a character vector:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">reported_heights</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "character"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we try to parse it into numbers, we get a warning:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">reported_heights</span><span class="op">$</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: NAs introduced by coercion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Although most values appear to be height in inches as requested we do end up with many <code>NA</code>s:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 81</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are some of the entries that are not successfully converted:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">reported_heights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>new_height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">new_height</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;             time_stamp    sex                 height new_height</span></span>
<span><span class="co">#&gt; 1  2014-09-02 15:16:28   Male                  5' 4"         NA</span></span>
<span><span class="co">#&gt; 2  2014-09-02 15:16:37 Female                  165cm         NA</span></span>
<span><span class="co">#&gt; 3  2014-09-02 15:16:52   Male                    5'7         NA</span></span>
<span><span class="co">#&gt; 4  2014-09-02 15:16:56   Male                  &gt;9000         NA</span></span>
<span><span class="co">#&gt; 5  2014-09-02 15:16:56   Male                   5'7"         NA</span></span>
<span><span class="co">#&gt; 6  2014-09-02 15:17:09 Female                   5'3"         NA</span></span>
<span><span class="co">#&gt; 7  2014-09-02 15:18:00   Male 5 feet and 8.11 inches         NA</span></span>
<span><span class="co">#&gt; 8  2014-09-02 15:19:48   Male                   5'11         NA</span></span>
<span><span class="co">#&gt; 9  2014-09-04 00:46:45   Male                  5'9''         NA</span></span>
<span><span class="co">#&gt; 10 2014-09-04 10:29:44   Male                 5'10''         NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We immediately see what is happening. Some of the students did not report their heights in inches as requested. We could discard these data and continue. However, many of the entries follow patterns that, in principle, we can easily convert to inches. For example, in the output above, we see various cases that use the format <code>x'y"</code> or <code>x'y''</code> with <code>x</code> and <code>y</code> representing feet and inches, respectively. Each one of these cases can be read and converted to inches by a human, for example <code>5'4"</code> is <code>5*12 + 4 = 64</code>. So we could fix all the problematic entries <em>by hand</em>. However, humans are prone to making mistakes, so an automated approach is preferable. Also, because we plan on continuing to collect data, it will be convenient to write code that automatically corrects entries entered in error.</p>
<p>A first step in this type of task is to survey the problematic entries and try to define specific patterns followed by a large groups of entries. The larger these groups, the more entries we can fix with a single programmatic approach. We want to find patterns that can be accurately described with a rule, such as “a digit, followed by a feet symbol, followed by one or two digits, followed by an inches symbol”.</p>
<p>To look for such patterns, it helps to remove the entries that are consistent with being in inches and to view only the problematic entries. We thus write a function to automatically do this. We keep entries that either result in <code>NA</code>s when applying <code>as.numeric</code> or are outside a range of plausible heights. We permit a range that covers about 99.9999% of the adult population. We also use <code>suppressWarnings</code> to avoid the warning message we know <code>as.numeric</code> will gives us.</p>
<p>We apply this function and find the number of problematic entries:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">problems</span> <span class="op">&lt;-</span> <span class="va">reported_heights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>inches <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">inches</span><span class="op">)</span> <span class="op">|</span> <span class="va">inches</span> <span class="op">&lt;</span> <span class="fl">50</span> <span class="op">|</span> <span class="va">inches</span> <span class="op">&gt;</span> <span class="fl">84</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">problems</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 292</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now view all the cases by simply printing them. If we do, we see that three patterns can be used to define three large groups within these exceptions.</p>
<p>1. A pattern of the form <code>x'y</code> or <code>x' y''</code> or <code>x'y"</code> with <code>x</code> and <code>y</code> representing feet and inches, respectively. Here are ten examples:</p>
<div class="cell" data-layout-align="center">
<pre><code>#&gt; 5' 4" 5'7 5'7" 5'3" 5'11 5'9'' 5'10'' 5' 10 5'5" 5'2"</code></pre>
</div>
<p>2. A pattern of the form <code>x.y</code> or <code>x,y</code> with <code>x</code> feet and <code>y</code> inches. Here are ten examples:</p>
<div class="cell" data-layout-align="center">
<pre><code>#&gt; 5.3 5.5 6.5 5.8 5.6 5,3 5.9 6,8 5.5 6.2</code></pre>
</div>
<p>3. Entries that were reported in centimeters rather than inches. Here are ten examples:</p>
<div class="cell" data-layout-align="center">
<pre><code>#&gt; 150 175 177 178 163 175 178 165 165 180</code></pre>
</div>
<p>Once we see these large groups following specific patterns, we can develop a plan of attack.</p>
<ol type="1">
<li>Convert entries fitting the first two patterns into one standardized one.</li>
<li>Leverage the standardization to extract the feet and inches and convert to inches.</li>
<li>Define a procedure for identifying entries that are in centimeters and convert them to inches.</li>
<li>Check again to see what entries were not fixed and see if we can tweak our approach to be more comprehensive.</li>
</ol>
<p>At the end, we hope to have a script that makes web-based data collection methods robust to the most common user mistakes.</p>
<p>Remember that there is rarely just one way to perform these tasks. Here we pick one that helps us teach several useful techniques. But surely there is a more efficient way of performing the task.</p>
<p>To achieve our goal, we will use a technique that enables us to accurately detect patterns and extract the parts we want: <em>regular expressions</em> (regex). But first, we quickly describe how to <em>escape</em> the function of certain characters so that they can be included in strings.</p>
</section><section id="escaping" class="level2" data-number="16.3"><h2 data-number="16.3" class="anchored" data-anchor-id="escaping">
<span class="header-section-number">16.3</span> Escaping</h2>
<p>To define strings in R, we can use either double quotes or single quotes:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">"Hello!"</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">'Hello!'</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Make sure you choose the correct single quote, as opposed to the back quote <code>`</code>.</p>
<p>Now, what happens if the string we want to define includes double quotes? For example, if we want to write 10 inches like this <code>10"</code>? In this case you can’t use:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="st">"10""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>because this is just the string <code>10</code> followed by a double quote. If you type this into R, you get an error because you failed to close the double quote. To avoid this, we can use the single quotes:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">'10"'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we print out <code>s</code> we see that the double quotes are <em>escaped</em> with the backslash <code>\</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span></span>
<span><span class="co">#&gt; [1] "10\""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In fact, escaping with the backslash provides a way to define the string while still using the double quotes to define strings:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">"10\""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In R, the function <code>cat</code> lets us see what the string actually looks like:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="co">#&gt; 10"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, what if we want our string to be 5 feet written like this <code>5'</code>? In this case, we can use the double quotes or escape the single quote</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">"5'"</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">'5\''</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So we’ve learned how to write 5 feet and 10 inches separately, but what if we want to write them together to represent <em>5 feet and 10 inches</em> like this <code>5'10"</code>? In this case, neither the single nor double quotes will work since <code>'5'10"'</code> closes the string after 5 and this <code>"5'10""</code> closes the string after 10. Keep in mind that if we type one of the above code snippets into R, it will get stuck waiting for you to close the open quote and you will have to exit the execution with the <em>esc</em> button.</p>
<p>To achieve the desired result we need to escape both quotes with the backslash <code>\</code>. You can escape either character that can be confused with a closing quote. These are the two options:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">'5\'10"'</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">"5'10\""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Escaping characters is something we often have to use when processing strings. Another characters that often needs escaping is the backslash character itself. We can do this with <code>\\</code>. When using regular expression, the topic of the next section, we often have to escape the <em>special characters</em> used in this approach.</p>
</section><section id="sec-regex" class="level2" data-number="16.4"><h2 data-number="16.4" class="anchored" data-anchor-id="sec-regex">
<span class="header-section-number">16.4</span> Regular expressions</h2>
<p>A regular expression (regex) is a way to describe specific patterns of characters of text. They can be used to determine if a given string matches the pattern. A set of rules has been defined to do this efficiently and precisely and here we show some examples. We can learn more about these rules by reading a detailed tutorials<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> <a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. The RStudio cheat sheet for <strong>stringr</strong> and regular expression<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> is also very useful.</p>
<p>The patterns supplied to the <strong>stringr</strong> functions can be a regex rather than a standard string. We will learn how this works through a series of examples.</p>
<p>Throughout this section you will see that we create strings to test out our regex. To do this, we define patterns that we know should match and also patterns that we know should not. We will call them <code>yes</code> and <code>no</code>, respectively. This permits us to check for the two types of errors: failing to match and incorrectly matching.</p>
<section id="strings-are-a-regex" class="level3" data-number="16.4.1"><h3 data-number="16.4.1" class="anchored" data-anchor-id="strings-are-a-regex">
<span class="header-section-number">16.4.1</span> Strings are a regex</h3>
<p>Technically any string is a regex, perhaps the simplest example is a single character. So the comma <code>,</code> used in the next code example is a simple example of searching with regex.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">","</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"10"</span>, <span class="st">"100"</span>, <span class="st">"1,000"</span>, <span class="st">"10,000"</span><span class="op">)</span>, <span class="va">pattern</span><span class="op">)</span> </span>
<span><span class="co">#&gt; [1] FALSE FALSE FALSE  TRUE  TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Above, we noted that an entry included a <code>cm</code>. This is also a simple example of a regex. We can show all the entries that used <code>cm</code> like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="va">reported_heights</span><span class="op">$</span><span class="va">height</span>, <span class="st">"cm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "165cm"  "170 cm"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="special-characters" class="level3" data-number="16.4.2"><h3 data-number="16.4.2" class="anchored" data-anchor-id="special-characters">
<span class="header-section-number">16.4.2</span> Special characters</h3>
<p>Now let’s consider a slightly more complicated example. Which of the following strings contain the pattern <code>cm</code> or <code>inches</code>?</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"180 cm"</span>, <span class="st">"70 inches"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"180"</span>, <span class="st">"70''"</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">no</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can do this with two searches:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"cm"</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"inches"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE  TRUE FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we don’t need to do this. The main feature that distinguishes the regex <em>language</em> from plain strings is that we can use special characters. These are characters with a meaning. We start by introducing <code>|</code> which means <em>or</em>. So if we want to know if either <code>cm</code> or <code>inches</code> appears in the strings, we can use the regex <code>cm|inches</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"cm|inches"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE  TRUE FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and obtain the correct answer.</p>
<p>Another special character that will be useful for identifying feet and inches values is <code>\d</code> which means any digit: 0, 1, 2, 3, 4, 5, 6, 7, 8, 9. The backslash is used to distinguish it from the character <code>d</code>. In R, we have to <em>escape</em> the backslash <code>\</code> so we actually have to use <code>\\d</code> to represent digits. Here is an example:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5"</span>, <span class="st">"6"</span>, <span class="st">"5'10"</span>, <span class="st">"5 feet"</span>, <span class="st">"4'11"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"."</span>, <span class="st">"Five"</span>, <span class="st">"six"</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">no</span><span class="op">)</span></span>
<span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"\\d"</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We take this opportunity to introduce the <code>str_view</code> function, which is helpful for troubleshooting as it shows us all matches for each string that has matches. Each match is surrounded by the characters <code>&lt;</code> and <code>&gt;</code>. Below, we see that <code>5</code> has one match and <code>5'10</code> has three matches.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_view.html">str_view</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="img/str_view-1.png" class="img-fluid" style="width:80.0%"></p>
<p>To view all strings, even if there wasn’t a match, we can use the <code>match = NA</code> parameter.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_view.html">str_view</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern</span>, match <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="img/str_view-2.png" class="img-fluid" style="width:80.0%"></p>
<p>Another useful special character is <code>\w</code> which stands for <em>word character</em> and it matches any letter, number, or underscore.</p>
<p>There are many other special characters. We will learn some others below, but you can see most or all of them in the cheat sheet<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> mentioned earlier.</p>
</section><section id="character-classes" class="level3" data-number="16.4.3"><h3 data-number="16.4.3" class="anchored" data-anchor-id="character-classes">
<span class="header-section-number">16.4.3</span> Character classes</h3>
<p>Character classes are used to define a series of characters that can be matched. We define character classes with square brackets <code>[]</code>. So, for example, if we want the pattern to match only if we have a <code>5</code> or a <code>6</code>, we use the regex <code>[56]</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_view.html">str_view</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"[56]"</span>, match <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="img/str_view-3.png" class="img-fluid" style="width:80.0%"></p>
<p>Suppose we want to match values between 4 and 7. A common way to define character classes is with ranges. So, for example, <code>[0-9]</code> is equivalent to <code>\\d</code>. The pattern we want is therefore <code>[4-7]</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">4</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">no</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"[4-7]"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, it is important to know that in regex everything is a character; there are no numbers. So <code>4</code> is the character <code>4</code> not the number four. Notice, for example, that <code>[1-20]</code> does <strong>not</strong> mean 1 through 20, it means the characters 1 through 2 or the character 0. So <code>[1-20]</code> simply means the character class composed of 0, 1, and 2.</p>
<p>Keep in mind that characters do have an order and the digits do follow the numeric order. So <code>0</code> comes before <code>1</code> which comes before <code>2</code> and so on. For the same reason, we can define lower case letters as <code>[a-z]</code>, upper case letters as <code>[A-Z]</code>, and <code>[a-zA-z]</code> as both.</p>
<p>Notice that <code>\w</code> is equivalent to <code>[a-zA-Z0-9_]</code>.</p>
</section><section id="anchors" class="level3" data-number="16.4.4"><h3 data-number="16.4.4" class="anchored" data-anchor-id="anchors">
<span class="header-section-number">16.4.4</span> Anchors</h3>
<p>What if we want a match when we have exactly 1 digit? This will be useful in our case study since feet are never more than 1 digit so a restriction will help us. One way to do this with regex is by using <em>anchors</em>, which let us define patterns that must start or end at a specific place. The two most common anchors are <code>^</code> and <code>$</code> which represent the beginning and end of a string, respectively. So the pattern <code>^\\d$</code> is read as “start of the string followed by one digit followed by end of string”.</p>
<p>This pattern now only detects the strings with exactly one digit:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"^\\d$"</span></span>
<span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"5"</span>, <span class="st">"9"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"12"</span>, <span class="st">"123"</span>, <span class="st">" 1"</span>, <span class="st">"a4"</span>, <span class="st">"b"</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">no</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_view.html">str_view</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern</span>, match <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="img/str_view-4.png" class="img-fluid" style="width:80.0%"></p>
<p>The <code>1</code> does not match because it does not start with the digit but rather with a space, which is not easy to see.</p>
</section><section id="bounded-quantifiers" class="level3" data-number="16.4.5"><h3 data-number="16.4.5" class="anchored" data-anchor-id="bounded-quantifiers">
<span class="header-section-number">16.4.5</span> Bounded quantifiers</h3>
<p>For the inches part, we can have one or two digits. This can be specified in regex with <em>quantifiers</em>. This is done by following the pattern with curly brackets containing the number of times the previous entry can be repeated. We call the <em>bounded</em> because the numbers in the quantifier are limited by the numbers in the curly brackets. Later we learn about <em>unbounded quantifiers</em>.</p>
<p>We use an example to illustrate. The pattern for one or two digits is:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"^\\d{1,2}$"</span></span>
<span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"5"</span>, <span class="st">"9"</span>, <span class="st">"12"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"123"</span>, <span class="st">"a4"</span>, <span class="st">"b"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_view.html">str_view</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">no</span><span class="op">)</span>, <span class="va">pattern</span>, match <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="img/str_view-5.png" class="img-fluid" style="width:80.0%"></p>
<p>In this case, <code>123</code> does <strong>not</strong> match, but <code>12</code> does. To look for our feet and inches pattern, we can add the symbols for feet <code>'</code> and inches <code>"</code> after the digits.</p>
<p>With what we have learned, we can now construct an example for the pattern <code>x'y"</code> with <code>x</code> feet and <code>y</code> inches.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"^[4-7]'\\d{1,2}\"$"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The pattern is now getting complex, but you can look at it carefully and break it down:</p>
<ul>
<li>
<code>^</code> = start of the string</li>
<li>
<code>[4-7]</code> = one digit, either 4,5,6 or 7</li>
<li>
<code>'</code> = feet symbol</li>
<li>
<code>\\d{1,2}</code> = one or two digits</li>
<li>
<code>\"</code> = inches symbol</li>
<li>
<code>$</code> = end of the string</li>
</ul>
<p>Let’s test it out:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5'7\""</span>, <span class="st">"6'2\""</span>,  <span class="st">"5'12\""</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"6,2\""</span>, <span class="st">"6.2\""</span>,<span class="st">"I am 5'11\""</span>, <span class="st">"3'2\""</span>, <span class="st">"64"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">pattern</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE TRUE</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">no</span>, <span class="va">pattern</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE FALSE FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For now, we are permitting the inches to be 12 or larger. We will add a restriction later as the regex for this is a bit more complex than we are ready to show.</p>
</section><section id="white-space" class="level3" data-number="16.4.6"><h3 data-number="16.4.6" class="anchored" data-anchor-id="white-space">
<span class="header-section-number">16.4.6</span> White space</h3>
<p>Another problem we have is spaces. For example, our pattern does not match <code>5' 4"</code> because there is a space between <code>'</code> and <code>4</code> which our pattern does not permit. Spaces are characters and R does not ignore them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="st">"Hi"</span>, <span class="st">"Hi "</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In regex, <code>\s</code> represents white space. To find patterns like <code>5' 4</code>, we can change our pattern to:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern_2</span> <span class="op">&lt;-</span> <span class="st">"^[4-7]'\\s\\d{1,2}\"$"</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="va">problems</span>, <span class="va">pattern_2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "5' 4\""  "5' 11\"" "5' 7\""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, this will not match the patterns with no space. So do we need more than one regex pattern? It turns out we can use a quantifier for this as well.</p>
</section><section id="unbounded-quantifiers" class="level3" data-number="16.4.7"><h3 data-number="16.4.7" class="anchored" data-anchor-id="unbounded-quantifiers">
<span class="header-section-number">16.4.7</span> Unbounded quantifiers: <code>*</code>, <code>?</code>, <code>+</code>
</h3>
<p>We want the pattern to permit spaces but not require them. Even if there are several spaces, like in this example <code>5'   4</code>, we still want it to match. There is a quantifier for exactly this purpose. In regex, the character <code>*</code> means zero or more instances of the previous character. Here is an example:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AB"</span>, <span class="st">"A1B"</span>, <span class="st">"A11B"</span>, <span class="st">"A111B"</span>, <span class="st">"A1111B"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A2B"</span>, <span class="st">"A21B"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">yes</span>, <span class="st">"A1*B"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE TRUE TRUE TRUE</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">no</span>, <span class="st">"A1*B"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The above matches the first string which has zero 1s and all the strings with one or more 1s. We can then improve our pattern by adding the <code>*</code> after the space character <code>\s</code>.</p>
<p>There are two other similar quantifiers. For none or once, we can use <code>?</code>, and for one or more, we can use <code>+</code>. You can see how they differ with this example:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>string <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"AB"</span>, <span class="st">"A1B"</span>, <span class="st">"A11B"</span>, <span class="st">"A111B"</span>, <span class="st">"A1111B"</span><span class="op">)</span>,</span>
<span>           none_or_more <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">yes</span>, <span class="st">"A1*B"</span><span class="op">)</span>,</span>
<span>           nore_or_once <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">yes</span>, <span class="st">"A1?B"</span><span class="op">)</span>,</span>
<span>           once_or_more <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">yes</span>, <span class="st">"A1+B"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   string none_or_more nore_or_once once_or_more</span></span>
<span><span class="co">#&gt; 1     AB         TRUE         TRUE        FALSE</span></span>
<span><span class="co">#&gt; 2    A1B         TRUE         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 3   A11B         TRUE        FALSE         TRUE</span></span>
<span><span class="co">#&gt; 4  A111B         TRUE        FALSE         TRUE</span></span>
<span><span class="co">#&gt; 5 A1111B         TRUE        FALSE         TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will actually use all three in our reported heights example, but we will see these in a later section.</p>
</section><section id="not" class="level3" data-number="16.4.8"><h3 data-number="16.4.8" class="anchored" data-anchor-id="not">
<span class="header-section-number">16.4.8</span> Not</h3>
<p>To specify patterns that we do <strong>not</strong> want to detect, we can use the <code>^</code> symbol but only <strong>inside</strong> square brackets. Remember that outside the square bracket <code>^</code> means the start of the string. So, for example, if we want to detect digits that are preceded by anything except a letter we can do the following:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"[^a-zA-Z]\\d"</span></span>
<span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".3"</span>, <span class="st">"+2"</span>, <span class="st">"-0"</span>,<span class="st">"*4"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"A3"</span>, <span class="st">"B2"</span>, <span class="st">"C0"</span>, <span class="st">"E4"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">pattern</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE TRUE TRUE TRUE</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">no</span>, <span class="va">pattern</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another way to generate a pattern that searches for <em>everything except</em> is to use the upper case of the special character. For example <code>\\D</code> means anything other than a digit, <code>\\S</code> means anything except a space, and so on.</p>
</section><section id="sec-groups" class="level3" data-number="16.4.9"><h3 data-number="16.4.9" class="anchored" data-anchor-id="sec-groups">
<span class="header-section-number">16.4.9</span> Groups</h3>
<p><em>Groups</em> are a powerful aspect of regex that permits the extraction of values. Groups are defined using parentheses. They don’t affect the pattern matching per se. Instead, it permits tools to identify specific parts of the pattern so we can extract them.</p>
<p>We want to change heights written like <code>5.6</code> to <code>5'6</code>.</p>
<p>To avoid changing patterns such as <code>70.2</code>, we will require that the first digit be between 4 and 7 <code>[4-7]</code> and that the second be none or more digits <code>\\d*</code>. Let’s start by defining a simple pattern that matches this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern_without_groups</span> <span class="op">&lt;-</span> <span class="st">"^[4-7],\\d*$"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We want to extract the digits so we can then form the new version using a period. These are our two groups, so we encapsulate them with parentheses:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern_with_groups</span> <span class="op">&lt;-</span>  <span class="st">"^([4-7]),(\\d*)$"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We encapsulate the part of the pattern that matches the parts we want to keep for later use. Adding groups does not affect the detection, since it only signals that we want to save what is captured by the groups. Note that both patterns return the same result when using <code>str_detect</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5,9"</span>, <span class="st">"5,11"</span>, <span class="st">"6,"</span>, <span class="st">"6,1"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5'9"</span>, <span class="st">","</span>, <span class="st">"2,8"</span>, <span class="st">"6.1.1"</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">no</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern_without_groups</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern_with_groups</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE  TRUE  TRUE  TRUE FALSE FALSE FALSE FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once we define groups, we can use the function <code>str_match</code> to extract the values these groups define:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_match.html">str_match</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern_with_groups</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1]   [,2] [,3]</span></span>
<span><span class="co">#&gt; [1,] "5,9"  "5"  "9" </span></span>
<span><span class="co">#&gt; [2,] "5,11" "5"  "11"</span></span>
<span><span class="co">#&gt; [3,] "6,"   "6"  ""  </span></span>
<span><span class="co">#&gt; [4,] "6,1"  "6"  "1" </span></span>
<span><span class="co">#&gt; [5,] NA     NA   NA  </span></span>
<span><span class="co">#&gt; [6,] NA     NA   NA  </span></span>
<span><span class="co">#&gt; [7,] NA     NA   NA  </span></span>
<span><span class="co">#&gt; [8,] NA     NA   NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that the second and third columns contain feet and inches, respectively. The first column is the part of the string matching the pattern. If no match occurred, we see an <code>NA</code>.</p>
<p>Now we can understand the difference between the functions <code>str_extract</code> and <code>str_match</code>. <code>str_extract</code> extracts only strings that match a pattern, not the values defined by groups:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html">str_extract</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern_with_groups</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "5,9"  "5,11" "6,"   "6,1"  NA     NA     NA     NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="search-and-replace" class="level3" data-number="16.4.10"><h3 data-number="16.4.10" class="anchored" data-anchor-id="search-and-replace">
<span class="header-section-number">16.4.10</span> Search and replace</h3>
<p>Earlier we defined the object <code>problems</code> containing the strings that do not appear to be in inches. We can see that not too many of our problematic strings match the pattern:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"^[4-7]'\\d{1,2}\"$"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">problems</span>, <span class="va">pattern</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To see why this is, we show some examples that expose why we don’t have more matches:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">problems</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">10</span>, <span class="fl">11</span>, <span class="fl">12</span>, <span class="fl">15</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_view.html">str_view</a></span><span class="op">(</span><span class="va">pattern</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="img/str_view-6.png" class="img-fluid" style="width:80.0%"></p>
<p>An initial problem we see immediately is that some students wrote out the words “feet” and “inches”. We can see the entries that did this with the <code>str_subset</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="va">problems</span>, <span class="st">"inches"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "5 feet and 8.11 inches" "Five foot eight inches"</span></span>
<span><span class="co">#&gt; [3] "5 feet 7inches"         "5ft 9 inches"          </span></span>
<span><span class="co">#&gt; [5] "5 ft 9 inches"          "5 feet 6 inches"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also see that some entries used two single quotes <code>''</code> instead of a double quote <code>"</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="va">problems</span>, <span class="st">"''"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "5'9''"   "5'10''"  "5'10''"  "5'3''"   "5'7''"   "5'6''"  </span></span>
<span><span class="co">#&gt;  [7] "5'7.5''" "5'7.5''" "5'10''"  "5'11''"  "5'10''"  "5'5''"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To correct this, we can replace the different ways of representing inches and feet with a uniform symbol. We will use <code>'</code> for feet, whereas for inches we will simply not use a symbol since some entries were of the form <code>x'y</code>. Now, if we no longer use the inches symbol, we have to change our pattern accordingly:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"^[4-7]'\\d{1,2}$"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we do this replacement before the matching, we get many more matches:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">problems</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"feet|ft|foot"</span>, <span class="st">"'"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># replace feet, ft, foot with ' </span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"inches|in|''|\""</span>, <span class="st">""</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># remove all inches symbols</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">pattern</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 48</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, we still have many cases to go.</p>
<p>Note that in the code above, we leveraged the <strong>stringr</strong> consistency and used the pipe.</p>
<p>For now, we improve our pattern by adding <code>\\s*</code> in front of and after the feet symbol <code>'</code> to permit space between the feet symbol and the numbers. Now we match a few more entries:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"^[4-7]\\s*'\\s*\\d{1,2}$"</span></span>
<span><span class="va">problems</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"feet|ft|foot"</span>, <span class="st">"'"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># replace feet, ft, foot with ' </span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"inches|in|''|\""</span>, <span class="st">""</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># remove all inches symbols</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">pattern</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 53</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We might be tempted to avoid doing this by removing all the spaces with <code>str_replace_all</code>. However, when doing such an operation we need to make sure that it does not have unintended effects. In our reported heights examples, this will be a problem because some entries are of the form <code>x y</code> with space separating the feet from the inches. If we remove all spaces, we will incorrectly turn <code>x y</code> into <code>xy</code> which implies that a <code>6 1</code> would become <code>61</code> inches instead of <code>73</code> inches.</p>
<p>The second large type of problematic entries were of the form <code>x.y</code>, <code>x,y</code> and <code>x y</code>. We want to change all these to our common format <code>x'y</code>. But we can’t just do a search and replace because we would change values such as <code>70.5</code> into <code>70'5</code>. Our strategy will therefore be to search for a very specific pattern that assures us feet and inches are being provided and then, for those that match, replace appropriately.</p>
</section><section id="search-and-replace-using-groups" class="level3" data-number="16.4.11"><h3 data-number="16.4.11" class="anchored" data-anchor-id="search-and-replace-using-groups">
<span class="header-section-number">16.4.11</span> Search and replace using groups</h3>
<p>Another powerful aspect of groups is that you can refer to the extracted values in a regex when searching and replacing.</p>
<p>The regex special character for the <code>i</code>-th group is <code>\\i</code>. So <code>\\1</code> is the value extracted from the first group, <code>\\2</code> the value from the second and so on. As a simple example, note that the following code will replace a comma with period, but only if it is after a digit between 4 and 7, and followed by zero or more digits:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern_with_groups</span> <span class="op">&lt;-</span>  <span class="st">"^([4-7]),(\\d*)$"</span></span>
<span><span class="va">yes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5,9"</span>, <span class="st">"5,11"</span>, <span class="st">"6,"</span>, <span class="st">"6,1"</span><span class="op">)</span></span>
<span><span class="va">no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5'9"</span>, <span class="st">","</span>, <span class="st">"2,8"</span>, <span class="st">"6.1.1"</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">yes</span>, <span class="va">no</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">pattern_with_groups</span>, <span class="st">"\\1'\\2"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "5'9"   "5'11"  "6'"    "6'1"   "5'9"   ","     "2,8"   "6.1.1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use this to convert cases in our reported heights.</p>
<p>We are now ready to define a pattern that helps us convert all the <code>x.y</code>, <code>x,y</code> and <code>x y</code> to our preferred format. We need to adapt <code>pattern_with_groups</code> to be a bit more flexible and capture all the cases.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern_with_groups</span> <span class="op">&lt;-</span> <span class="st">"^([4-7])\\s*[,\\.\\s+]\\s*(\\d*)$"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s break this one down:</p>
<ul>
<li>
<code>^</code> = start of the string</li>
<li>
<code>[4-7]</code> = one digit representing feet, either 4, 5, 6, or 7</li>
<li>
<code>\\s*</code> = none or more white space</li>
<li>
<code>[,\\.\\s+]</code> = feet and inches are separated by either <code>,</code>, <code>.</code> or at least one space</li>
<li>
<code>\\s*</code> = none or more white space</li>
<li>
<code>\\d*</code> = none or more digits representing inches</li>
<li>
<code>$</code> = end of the string</li>
</ul>
<p>We can see that it appears to be working:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="va">problems</span>, <span class="va">pattern_with_groups</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "5.3"  "5.25" "5.5"  "6.5"  "5.8"  "5.6"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and will be able to perform the search and replace:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="va">problems</span>, <span class="va">pattern_with_groups</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="va">pattern_with_groups</span>, <span class="st">"\\1'\\2"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "5'3"  "5'25" "5'5"  "6'5"  "5'8"  "5'6"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again, we will deal with the inches-larger-than-twelve challenge later.</p>
</section><section id="lookarounds" class="level3" data-number="16.4.12"><h3 data-number="16.4.12" class="anchored" data-anchor-id="lookarounds">
<span class="header-section-number">16.4.12</span> Lookarounds</h3>
<p>Lookarounds provide a way to ask for one or more conditions to be satisfied without moving the search forward or matching it. For example, you might want to check for multiple conditions and if they are matched, then return the pattern or part of the pattern that matched.</p>
<p>There are four types of lookarounds: lookahead <code>(?=pattern)</code>, lookbehind <code>(?&lt;=pattern)</code>, negative lookahead <code>(?!pattern)</code>, and negative lookbehind <code>(?&lt;!pattern)</code>.</p>
<p>The conventional example checking password that must satisfy several conditions such as 1) 8-16 word characters, 2) starts with a letter, and 3) has at least one digit. You can concatenate lookarounds to check for multiple conditions. For our example we can write</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pattern</span> <span class="op">&lt;-</span> <span class="st">"(?=\\w{8,16})(?=^[a-z|A-Z].*)(?=.*\\d+.*)"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A simpler example is changing all <code>superman</code> to <code>supergirl</code> without changing all the men to girl. We could use a lookaround like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">"Superman saved a man. The man thanked superman."</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"(?&lt;=[Ss]uper)man"</span>, <span class="st">"girl"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Supergirl saved a man. The man thanked supergirl."</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-separate_regex" class="level3" data-number="16.4.13"><h3 data-number="16.4.13" class="anchored" data-anchor-id="sec-separate_regex">
<span class="header-section-number">16.4.13</span> Separating variables</h3>
<p>In <a href="reshaping-data.html#sec-separate" class="quarto-xref"><span>Section 11.3</span></a> we introduced functions that can split columns into new ones. The <code>separate_wider_regex</code> uses regex instead of delimiters to separate variables in data frames. It uses an approach similar to regex groups and turns each of groups into a new column.</p>
<p>Suppose we have data frame like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5'10"</span>, <span class="st">"6' 1"</span>, <span class="st">"5 ' 9"</span>, <span class="st">"5'11\""</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that using <code>separate_wider_delim</code> won’t work here because the delimiter can varies across entries. With <code>separate_wider_regex</code> we can define flexible patterns that are matched to define each column.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>feet <span class="op">=</span> <span class="st">"\\d"</span>, <span class="st">"\\s*'\\s*"</span>, inches <span class="op">=</span> <span class="st">"\\d{1,2}"</span>, <span class="st">".*"</span><span class="op">)</span></span>
<span><span class="va">tab</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_regex</a></span><span class="op">(</span><span class="va">x</span>, patterns <span class="op">=</span> <span class="va">patterns</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 2</span></span>
<span><span class="co">#&gt;   feet  inches</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1 5     10    </span></span>
<span><span class="co">#&gt; 2 6     1     </span></span>
<span><span class="co">#&gt; 3 5     9     </span></span>
<span><span class="co">#&gt; 4 5     11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By not naming the second and fourth entries of <code>patterns</code> we tell the function not to keep the values that match that pattern.</p>
</section></section><section id="trimming" class="level2" data-number="16.5"><h2 data-number="16.5" class="anchored" data-anchor-id="trimming">
<span class="header-section-number">16.5</span> Trimming</h2>
<p>In general, spaces at the start or end of the string are uninformative. These can be particularly deceptive because sometimes they can be hard to see:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="st">"Hi "</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="co">#&gt; Hi</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"Hi"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a general enough problem that there is a function dedicated to removing them: <code>str_trim</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="st">"5 ' 9 "</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "5 ' 9"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="case-conversion" class="level2" data-number="16.6"><h2 data-number="16.6" class="anchored" data-anchor-id="case-conversion">
<span class="header-section-number">16.6</span> Case conversion</h2>
<p>Notice that regex is case sensitive. Often we want to match a word regardless of case. One approach to doing this is to first change everything to lower case and then proceeding ignoring case. As an example, note that one of the entries writes out numbers as words <code>Five foot eight inches</code>. Although not efficient, we could add 13 extra <code>str_replace</code> calls to convert <code>zero</code> to <code>0</code>, <code>one</code> to <code>1</code>, and so on. To avoid having to write two separate operations for <code>Zero</code> and <code>zero</code>, <code>One</code> and <code>one</code>, etc., we can use the <code>str_to_lower</code> function to make all works lower case first:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Five feet eight inches"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "five feet eight inches"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Other related functions are <code>str_to_upper</code> and <code>str_to_title</code>. We are now ready to define a procedure that converts all the problematic cases to inches.</p>
</section><section id="case-study-1-continued-putting-it-all-together" class="level2" data-number="16.7"><h2 data-number="16.7" class="anchored" data-anchor-id="case-study-1-continued-putting-it-all-together">
<span class="header-section-number">16.7</span> Case study 1 continued: Putting it all together</h2>
<p>We are now ready to put it all together and wrangle our reported heights data to try to recover as many heights as possible. The code is complex, but we will break it down into parts.</p>
<p>Let’s see how many problematic entries we can recover with the approaches we covered in <a href="#sec-regex" class="quarto-xref"><span>Section 16.4</span></a>. We will first define a function that detects entries that are not reported as inches or centimeters:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">not_inches_or_cm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">smallest</span> <span class="op">=</span> <span class="fl">50</span>, <span class="va">tallest</span> <span class="op">=</span> <span class="fl">84</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">inches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">inches</span><span class="op">)</span> <span class="op">|</span></span>
<span>    <span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="va">inches</span> <span class="op">&gt;=</span> <span class="va">smallest</span> <span class="op">&amp;</span> <span class="va">inches</span> <span class="op">&lt;=</span> <span class="va">tallest</span><span class="op">)</span> <span class="op">|</span></span>
<span>        <span class="op">(</span><span class="va">inches</span><span class="op">/</span><span class="fl">2.54</span> <span class="op">&gt;=</span> <span class="va">smallest</span> <span class="op">&amp;</span> <span class="va">inches</span><span class="op">/</span><span class="fl">2.54</span> <span class="op">&lt;=</span> <span class="va">tallest</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see how many entries are not inches or centimeters:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">problems</span> <span class="op">&lt;-</span> <span class="va">reported_heights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">not_inches_or_cm</span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">problems</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 200</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see how many feet<code>'</code>inches format we can recover applying the finding from <a href="#sec-regex" class="quarto-xref"><span>Section 16.4</span></a>. Specifically we replace feet/foot/ft with <code>'</code>, we remove the word inches and its abbreviations, then rewrite similar patterns into the desired feet<code>'</code>inches pattern. Once this is done we see what proportion don’t fit the desired pattern</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">converted</span> <span class="op">&lt;-</span> <span class="va">problems</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"feet|foot|ft"</span>, <span class="st">"'"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="st">"inches|in|''|\""</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"^([4-7])\\s*[,\\.\\s+]\\s*(\\d*)$"</span>, <span class="st">"\\1'\\2"</span><span class="op">)</span> </span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">converted</span>, <span class="st">"^[4-7]\\s*'\\s*\\d{1,2}$"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">!</span><span class="va">index</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.385</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that a substantial proportion has not yet been fixed. Trial and error is a common approach to finding the regex pattern that satisfies all desired conditions. We can examine the remaining cases to try to decipher if new patterns we can use to fix them:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">converted</span><span class="op">[</span><span class="op">!</span><span class="va">index</span><span class="op">]</span></span>
<span><span class="co">#&gt;  [1] "6"             "165cm"         "511"           "6"            </span></span>
<span><span class="co">#&gt;  [5] "2"             "&gt;9000"         "5 ' and 8.11 " "11111"        </span></span>
<span><span class="co">#&gt;  [9] "6"             "103.2"         "19"            "5"            </span></span>
<span><span class="co">#&gt; [13] "300"           "6'"            "6"             "Five ' eight "</span></span>
<span><span class="co">#&gt; [17] "7"             "214"           "6"             "0.7"          </span></span>
<span><span class="co">#&gt; [21] "6"             "2'33"          "612"           "1,70"         </span></span>
<span><span class="co">#&gt; [25] "87"            "5'7.5"         "5'7.5"         "111"          </span></span>
<span><span class="co">#&gt; [29] "5' 7.78"       "12"            "6"             "yyy"          </span></span>
<span><span class="co">#&gt; [33] "89"            "34"            "25"            "6"            </span></span>
<span><span class="co">#&gt; [37] "6"             "22"            "684"           "6"            </span></span>
<span><span class="co">#&gt; [41] "1"             "1"             "6*12"          "87"           </span></span>
<span><span class="co">#&gt; [45] "6"             "1.6"           "120"           "120"          </span></span>
<span><span class="co">#&gt; [49] "23"            "1.7"           "6"             "5"            </span></span>
<span><span class="co">#&gt; [53] "69"            "5' 9 "         "5 ' 9 "        "6"            </span></span>
<span><span class="co">#&gt; [57] "6"             "86"            "708,661"       "5 ' 6 "       </span></span>
<span><span class="co">#&gt; [61] "6"             "649,606"       "10000"         "1"            </span></span>
<span><span class="co">#&gt; [65] "728,346"       "0"             "6"             "6"            </span></span>
<span><span class="co">#&gt; [69] "6"             "100"           "88"            "6"            </span></span>
<span><span class="co">#&gt; [73] "170 cm"        "7,283,465"     "5"             "5"            </span></span>
<span><span class="co">#&gt; [77] "34"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We noticed that two students added <code>cm</code> and some entries have space at the end so we write incorporate this into our cleanup stage. We also notice that at least one entry wrote out numbers such as <code>Five foot eight inches</code>. We can use the <code><a href="https://rdrr.io/pkg/english/man/words.html">words()</a></code> function in the <strong>english</strong> package to change these to actual numbers. In preparation for our final product, we define a function that cleans up previously noticed problems and these new ones:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">english</span><span class="op">)</span></span>
<span><span class="va">cleanup</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"inches|in|''|\"|cm|and"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="va">s</span>, <span class="fu"><a href="https://rdrr.io/pkg/english/man/words.html">words</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Many also notice that students measuring exactly 5 or 6 feet did not enter any inches, for example <code>6'</code>, and our pattern requires that inches be included, and that some entries are in meters and some of these use European decimals, for example <code>1.6</code> and <code>1,70</code>. So we create a function that add these corrections to those already identified as needed to reformat the entry as feet<code>'</code>inches:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">convert_format</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">s</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"feet|foot|ft"</span>, <span class="st">"'"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"^([4-7])\\s*[,\\.\\s+]\\s*(\\d*)$"</span>, <span class="st">"\\1'\\2"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"^([56])'?$"</span>, <span class="st">"\\1'0"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"^([12])\\s*,\\s*(\\d*)$"</span>, <span class="st">"\\1\\.\\2"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to wrangle our reported heights dataset. The strategy is as follows:</p>
<p>1. We start by defining a variable to keep a copy of the original entry, we then clean up and covert the <code>height</code> entry using the functions described above.</p>
<p>2. We then use the <code>separate_wider_regex_</code> function to extract feet and inches when the entry matches our feet<code>'</code>inches format.</p>
<p>3. We use a lookaround to make sure that entries that have numbers with no <code>'</code> following them don’t match and return an <code>NA</code>.</p>
<p>4.&nbsp;Once this is done, we convert the feet and inches into inches.</p>
<p>5.&nbsp;Finally, we decide if the entries are in inches, centimeters, or meters and convert appropriately.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>feet <span class="op">=</span> <span class="st">"[4-7](?=\\s*'\\s*)"</span>, </span>
<span>              <span class="st">"\\s*'\\s*"</span>, </span>
<span>              inches <span class="op">=</span> <span class="st">"\\d+\\.?\\d*"</span><span class="op">)</span></span>
<span><span class="va">smallest</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">tallest</span> <span class="op">&lt;-</span> <span class="fl">84</span></span>
<span><span class="va">new_heights</span> <span class="op">&lt;-</span> <span class="va">reported_heights</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>original <span class="op">=</span> <span class="va">height</span>, </span>
<span>         height <span class="op">=</span> <span class="fu">convert_format</span><span class="op">(</span><span class="fu">cleanup</span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate_wider_delim.html">separate_wider_regex</a></span><span class="op">(</span><span class="va">height</span>, patterns <span class="op">=</span> <span class="va">patterns</span>, </span>
<span>                       too_few <span class="op">=</span> <span class="st">"align_start"</span>, </span>
<span>                       cols_remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">feet</span>, <span class="va">inches</span><span class="op">)</span>, <span class="va">as.numeric</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>guess <span class="op">=</span> <span class="fl">12</span> <span class="op">*</span> <span class="va">feet</span> <span class="op">+</span> <span class="va">inches</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">smallest</span>, <span class="va">tallest</span><span class="op">)</span> <span class="op">~</span> <span class="va">height</span>,  <span class="co">#inches</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">height</span><span class="op">/</span><span class="fl">2.54</span>, <span class="va">smallest</span>, <span class="va">tallest</span><span class="op">)</span> <span class="op">~</span> <span class="va">height</span><span class="op">/</span><span class="fl">2.54</span>, <span class="co">#cm</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">height</span><span class="op">*</span><span class="fl">100</span><span class="op">/</span><span class="fl">2.54</span>, <span class="va">smallest</span>, <span class="va">tallest</span><span class="op">)</span> <span class="op">~</span> <span class="va">height</span><span class="op">*</span><span class="fl">100</span><span class="op">/</span><span class="fl">2.54</span>, <span class="co">#meters</span></span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                           <span class="va">inches</span> <span class="op">&lt;=</span> <span class="fl">12</span> <span class="op">&amp;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="va">guess</span>, <span class="va">smallest</span>, <span class="va">tallest</span><span class="op">)</span>,</span>
<span>                         <span class="va">guess</span>, <span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">feet</span>, <span class="op">-</span><span class="va">inches</span>, <span class="op">-</span><span class="va">guess</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that we fix all but 44 entries. You can see that these are mostly un-fixable:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new_heights</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">original</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "511"       "&gt;9000"     "5.25"      "11111"     "103.2"    </span></span>
<span><span class="co">#&gt;  [6] "19"        "300"       "5.75"      "7"         "214"      </span></span>
<span><span class="co">#&gt; [11] "0.7"       "2'33"      "612"       "87"        "111"      </span></span>
<span><span class="co">#&gt; [16] "12"        "yyy"       "89"        "34"        "25"       </span></span>
<span><span class="co">#&gt; [21] "22"        "684"       "1"         "1"         "6*12"     </span></span>
<span><span class="co">#&gt; [26] "87"        "120"       "120"       "23"        "5.51"     </span></span>
<span><span class="co">#&gt; [31] "5.69"      "86"        "708,661"   "5.25"      "649,606"  </span></span>
<span><span class="co">#&gt; [36] "10000"     "1"         "728,346"   "0"         "100"      </span></span>
<span><span class="co">#&gt; [41] "5.57"      "88"        "7,283,465" "34"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can review the ones we did fix by typing:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new_heights</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">not_inches_or_cm</span><span class="op">(</span><span class="va">original</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">original</span>, <span class="va">height</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A final observation is that if we look at the shortest students in our course:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new_heights</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">height</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 4</span></span>
<span><span class="co">#&gt;   time_stamp          sex    height original</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;               &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;   </span></span>
<span><span class="co">#&gt; 1 2017-07-04 01:30:25 Male       50 50      </span></span>
<span><span class="co">#&gt; 2 2017-09-07 10:40:35 Male       50 50      </span></span>
<span><span class="co">#&gt; 3 2014-09-02 15:18:30 Female     51 51      </span></span>
<span><span class="co">#&gt; 4 2016-06-05 14:07:20 Female     52 52      </span></span>
<span><span class="co">#&gt; 5 2016-06-05 14:07:38 Female     52 52      </span></span>
<span><span class="co">#&gt; # ℹ 1 more row</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see heights of 50, 51, 52, and so on. These short heights are rare and it is likely that the students actually meant 5’0, 5’1, 5’2 and so on. Because we are not completely sure, we will leave them as reported. The object new_heights contains our final solution for this case study.</p>
</section><section id="case-study-2-extracting-tables-from-a-pdf" class="level2" data-number="16.8"><h2 data-number="16.8" class="anchored" data-anchor-id="case-study-2-extracting-tables-from-a-pdf">
<span class="header-section-number">16.8</span> Case study 2: extracting tables from a PDF</h2>
<p>One of the datasets provided in <strong>dslabs</strong> shows scientific funding rates by gender in the Netherlands:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dslabs</span><span class="op">)</span></span>
<span><span class="va">research_funding_rates</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="st">"discipline"</span>, <span class="st">"success_rates_men"</span>, <span class="st">"success_rates_women"</span><span class="op">)</span></span>
<span><span class="co">#&gt;            discipline success_rates_men success_rates_women</span></span>
<span><span class="co">#&gt; 1   Chemical sciences              26.5                25.6</span></span>
<span><span class="co">#&gt; 2   Physical sciences              19.3                23.1</span></span>
<span><span class="co">#&gt; 3             Physics              26.9                22.2</span></span>
<span><span class="co">#&gt; 4          Humanities              14.3                19.3</span></span>
<span><span class="co">#&gt; 5  Technical sciences              15.9                21.0</span></span>
<span><span class="co">#&gt; 6   Interdisciplinary              11.4                21.8</span></span>
<span><span class="co">#&gt; 7 Earth/life sciences              24.4                14.3</span></span>
<span><span class="co">#&gt; 8     Social sciences              15.3                11.5</span></span>
<span><span class="co">#&gt; 9    Medical sciences              18.8                11.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data comes from a paper published in the Proceedings of the National Academy of Science (PNAS)<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>, a widely read scientific journal. However, the data is not provided in a spreadsheet; it is in a table in a PDF document. Here is a screenshot of the table:</p>
<p><img src="img/pnas-table-s1.png" class="img-fluid"></p>
<p>(Source: Romy van der Lee and Naomi Ellemers, PNAS 2015 112 (40) 12349-12353<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.)</p>
<p>We could extract the numbers by hand, but this could lead to human error. Instead, we can try to wrangle the data using R. We start by downloading the pdf document, then importing into R:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://ropensci.r-universe.dev/pdftools">"pdftools"</a></span><span class="op">)</span></span>
<span><span class="va">temp_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"https://web.archive.org/web/20150927033124/"</span>,</span>
<span>              <span class="st">"https://www.pnas.org/content/suppl/2015/09/16/"</span>,</span>
<span>              <span class="st">"1510159112.DCSupplemental/pnas.201510159SI.pdf"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">temp_file</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span>
<span><span class="va">txt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/pdftools//reference/pdftools.html">pdf_text</a></span><span class="op">(</span><span class="va">temp_file</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.remove</a></span><span class="op">(</span><span class="va">temp_file</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>The <code>mode = "wb"</code> argument is only necessary if using Microsoft Windows. On MacOs or Linux the default <code>mode = "w"</code> works. To understand this difference please refer to the <code>download.file</code> help file.</p>
</div>
</div>
</div>
<p>If we examine the object text, we notice that it is a character vector with an entry for each page. So we keep the page we want:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_data_research_funding_rates</span> <span class="op">&lt;-</span> <span class="va">txt</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The steps above can actually be skipped because we include this raw data in the <strong>dslabs</strong> package as well.</p>
<p>Examining the object <code>raw_data_research_funding_rates</code> we see that it is a long string and each line on the page, including the table rows, are separated by the symbol for newline: <code>\n</code>. A first step in converting this into a data frame is to store rows separately in a way that will make them easy to access. For this we use the <code>str_split</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="va">raw_data_research_funding_rates</span>, <span class="st">"\n+"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>On MacOS or Linux you can simply use <code>\n</code> as the separator. Microsoft Windows and macOS (which is based on Unix) use different conventions for line endings in text files and a result <code>raw_data_research_funding_rates</code> has more <code>\n</code> when using Windows.</p>
</div>
</div>
</div>
<p>Because we start off with just one string, we end up with a list with just one entry.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tab</span> <span class="op">&lt;-</span> <span class="va">tab</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By examining <code>tab</code> we see that the information for the column names is the third and fourth entries:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">the_names_1</span> <span class="op">&lt;-</span> <span class="va">tab</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span><span class="va">the_names_2</span> <span class="op">&lt;-</span> <span class="va">tab</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first of these rows looks like this:</p>
<div class="cell" data-layout-align="center">
<pre><code>#&gt;                                                       Applications, n
#&gt;                   Awards, n                      Success rates, %</code></pre>
</div>
<p>We want to create one vector with one name for each column. Using some of the functions we have just learned, we do this.</p>
<p>Let’s start with <code>the_names_1</code>, shown above. We want to remove the leading space and anything following the comma. We use regex for the latter. Then we can obtain the elements by splitting strings separated by space. We want to split only when there are 2 or more spaces to avoid splitting <code>Success rates</code>. So we use the regex <code>\\s{2,}</code></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">the_names_1</span> <span class="op">&lt;-</span> <span class="va">the_names_1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="st">",\\s."</span>, <span class="st">""</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="st">"\\s{2,}"</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">the_names_1</span> </span>
<span><span class="co">#&gt;      [,1]           [,2]     [,3]           </span></span>
<span><span class="co">#&gt; [1,] "Applications" "Awards" "Success rates"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we will look at <code>the_names_2</code>:</p>
<div class="cell" data-layout-align="center">
<pre><code>#&gt;                         Discipline              Total     Men      Women
#&gt; n         Total    Men       Women          Total    Men      Women</code></pre>
</div>
<p>Here we want to trim the leading space and then split by space as we did for the first line:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">the_names_2</span> <span class="op">&lt;-</span> <span class="va">the_names_2</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="st">"\\s+"</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">the_names_2</span></span>
<span><span class="co">#&gt;      [,1]         [,2]    [,3]  [,4]    [,5]    [,6]  [,7]    [,8]   </span></span>
<span><span class="co">#&gt; [1,] "Discipline" "Total" "Men" "Women" "Total" "Men" "Women" "Total"</span></span>
<span><span class="co">#&gt;      [,9]  [,10]  </span></span>
<span><span class="co">#&gt; [1,] "Men" "Women"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then join these to generate one name for each column:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tmp_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">the_names_1</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="va">the_names_2</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span><span class="va">the_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">the_names_2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">tmp_names</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_lower</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="st">"\\s"</span>, <span class="st">"_"</span><span class="op">)</span></span>
<span><span class="va">the_names</span></span>
<span><span class="co">#&gt;  [1] "discipline"          "applications_total"  "applications_men"   </span></span>
<span><span class="co">#&gt;  [4] "applications_women"  "awards_total"        "awards_men"         </span></span>
<span><span class="co">#&gt;  [7] "awards_women"        "success_rates_total" "success_rates_men"  </span></span>
<span><span class="co">#&gt; [10] "success_rates_women"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to get the actual data. By examining the <code>tab</code> object, we notice that the information is in lines 6 through 14. We can use <code>str_split</code> again to achieve our goal:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">new_research_funding_rates</span> <span class="op">&lt;-</span> <span class="va">tab</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">14</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="st">"\\s{2,}"</span>, simplify <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">the_names</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="va">parse_number</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">new_research_funding_rates</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 9 × 10</span></span>
<span><span class="co">#&gt;   discipline      applications_total applications_men applications_women</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                        &lt;dbl&gt;            &lt;dbl&gt;              &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Chemical scien…                122               83                 39</span></span>
<span><span class="co">#&gt; 2 Physical scien…                174              135                 39</span></span>
<span><span class="co">#&gt; 3 Physics                         76               67                  9</span></span>
<span><span class="co">#&gt; 4 Humanities                     396              230                166</span></span>
<span><span class="co">#&gt; 5 Technical scie…                251              189                 62</span></span>
<span><span class="co">#&gt; # ℹ 4 more rows</span></span>
<span><span class="co">#&gt; # ℹ 6 more variables: awards_total &lt;dbl&gt;, awards_men &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   awards_women &lt;dbl&gt;, success_rates_total &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   success_rates_men &lt;dbl&gt;, success_rates_women &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that the objects are identical:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">research_funding_rates</span>, <span class="va">new_research_funding_rates</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-recode" class="level2" data-number="16.9"><h2 data-number="16.9" class="anchored" data-anchor-id="sec-recode">
<span class="header-section-number">16.9</span> Renaming levels</h2>
<p>Another common operation involving strings is renaming the levels of of a categorical variables. Let’s say you have really long names for your levels. If you will be displaying them in plots, you might want to use shorter versions of these names. For example, in character vectors with country names, you might want to change “United States of America” to “USA” and “United Kingdom” to UK, and so on.</p>
<p>Rather than changing each entry, a more efficient approach is to change the levels.</p>
<p>Here is an example that shows how to rename countries with long names:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">dslabs</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Suppose we want to show life expectancy time series by country for the Caribbean. If we make this plot</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Caribbean"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">life_expectancy</span>, color <span class="op">=</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="string-processing_files/figure-html/caribbean-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>we see that the legend takes up much of the plot because we have four countries with names longer than 12 characters. We can rename these levels using the <code>case_when</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">country</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>  <span class="va">x</span> <span class="op">==</span> <span class="st">"Antigua and Barbuda"</span> <span class="op">~</span> <span class="st">"Barbuda"</span>,</span>
<span>  <span class="va">x</span> <span class="op">==</span> <span class="st">"Dominican Republic"</span> <span class="op">~</span> <span class="st">"DR"</span>,</span>
<span>  <span class="va">x</span> <span class="op">==</span> <span class="st">"St. Vincent and the Grenadines"</span> <span class="op">~</span> <span class="st">"St. Vincent"</span>,</span>
<span>  <span class="va">x</span> <span class="op">==</span> <span class="st">"Trinidad and Tobago"</span> <span class="op">~</span> <span class="st">"Trinidad"</span>,</span>
<span>  .default <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Caribbean"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">life_expectancy</span>, color <span class="op">=</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="string-processing_files/figure-html/country-long-names-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:70.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can instead use the <code>fct_recode</code> function in the <strong>forcats</strong> package:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/">forcats</a></span><span class="op">)</span></span>
<span><span class="va">gapminder</span><span class="op">$</span><span class="va">country</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_recode.html">fct_recode</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">$</span><span class="va">country</span>, </span>
<span>             <span class="st">"Barbuda"</span> <span class="op">=</span> <span class="st">"Antigua and Barbuda"</span>,</span>
<span>             <span class="st">"DR"</span> <span class="op">=</span> <span class="st">"Dominican Republic"</span>,</span>
<span>             <span class="st">"St. Vincent"</span> <span class="op">=</span> <span class="st">"St. Vincent and the Grenadines"</span>,</span>
<span>             <span class="st">"Trinidad"</span> <span class="op">=</span> <span class="st">"Trinidad and Tobago"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercises" class="level2" data-number="16.10"><h2 data-number="16.10" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">16.10</span> Exercises</h2>
<p>1. Complete all lessons and exercises in the RegexOne<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> online interactive tutorial.</p>
<p>2. In the <code>extdata</code> directory of the <strong>dslabs</strong> package, you will find a PDF file containing daily mortality data for Puerto Rico from Jan 1, 2015 to May 31, 2018. You can find the file like this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"RD-Mortality-Report_2015-18-180531.pdf"</span>,</span>
<span>                  package<span class="op">=</span><span class="st">"dslabs"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Find and open the file or open it directly from RStudio. On a Mac, you can type:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system2.html">system2</a></span><span class="op">(</span><span class="st">"open"</span>, args <span class="op">=</span> <span class="va">fn</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and on Windows, you can type:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.html">system</a></span><span class="op">(</span><span class="st">"cmd.exe"</span>, input <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"start"</span>, <span class="va">fn</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which of the following best describes this file:</p>
<ol type="a">
<li>It is a table. Extracting the data will be easy.</li>
<li>It is a report written in prose. Extracting the data will be impossible.</li>
<li>It is a report combining graphs and tables. Extracting the data seems possible.</li>
<li>It shows graphs of the data. Extracting the data will be difficult.</li>
</ol>
<p>3. We are going to create a tidy dataset with each row representing one observation. The variables in this dataset will be year, month, day, and deaths. Start by installing and loading the <strong>pdftools</strong> package:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"pdftools"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ropensci.r-universe.dev/pdftools">pdftools</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now read-in <code>fn</code> using the <code>pdf_text</code> function and store the results in an object called <code>txt</code>. Which of the following best describes what you see in <code>txt</code>?</p>
<ol type="a">
<li>A table with the mortality data.</li>
<li>A character string of length 12. Each entry represents the text in each page. The mortality data is in there somewhere.</li>
<li>A character string with one entry containing all the information in the PDF file.</li>
<li>An html document.</li>
</ol>
<p>4. Extract the ninth page of the PDF file from the object <code>txt</code>, then use the <code>str_split</code> from the <strong>stringr</strong> package so that you have each line in a different entry. Call this string vector <code>s</code>. Then look at the result and choose the one that best describes what you see.</p>
<ol type="a">
<li>It is an empty string.</li>
<li>I can see the figure shown in page 1.</li>
<li>It is a tidy table.</li>
<li>I can see the table! But there is a bunch of other stuff we need to get rid of.</li>
</ol>
<p>5. What kind of object is <code>s</code> and how many entries does it have?</p>
<p>6. We see that the output is a list with one component. Redefine <code>s</code> to be the first entry of the list. What kind of object is <code>s</code> and how many entries does it have?</p>
<p>7. When inspecting the string we obtained above, we see a common problem: white space before and after the other characters. Trimming is a common first step in string processing. These extra spaces will eventually make splitting the strings hard so we start by removing them. We learned about the command <code>str_trim</code> that removes spaces at the start or end of the strings. Use this function to trim <code>s</code>.</p>
<p>8. We want to extract the numbers from the strings stored in <code>s</code>. However, there are many non-numeric characters that will get in the way. We can remove these, but before doing this we want to preserve the string with the column header, which includes the month abbreviation. Use the <code>str_which</code> function to find the rows with a header. Save these results to <code>header_index</code>. Hint: find the first string that matches the pattern <code>2015</code> using the <code>str_which</code> function.</p>
<p>9. Now we are going to define two objects: <code>month</code> will store the month and <code>header</code> will store the column names. Identify which row contains the header of the table. Save the content of the row into an object called <code>header</code>, then use <code>str_split</code> to help define the two objects we need. Hints: the separator here is one or more spaces. Also, consider using the <code>simplify</code> argument.</p>
<p>10. Notice that towards the end of the page you see a <em>totals</em> row followed by rows with other summary statistics. Create an object called <code>tail_index</code> with the index of the <em>totals</em> entry.</p>
<p>11. Because our PDF page includes graphs with numbers, some of our rows have just one number (from the y-axis of the plot). Use the <code>str_count</code> function to create an object <code>n</code> with the number of numbers in each each row. Hint: you can write a regex for number like this <code>\\d+</code>.</p>
<p>12. We are now ready to remove entries from rows that we know we don’t need. The entry <code>header_index</code> and everything before it should be removed. Entries for which <code>n</code> is 1 should also be removed, and the entry <code>tail_index</code> and everything that comes after it should be removed as well.</p>
<p>13. Now we are ready to remove all the non-numeric entries. Do this using regex and the <code>str_remove_all</code> function. Hint: remember that in regex, using the upper case version of a special character usually means the opposite. So <code>\\D</code> means “not a digit”. Remember you also want to keep spaces.</p>
<p>14. To convert the strings into a table, use the <code>str_split_fixed</code> function. Convert <code>s</code> into a data matrix with just the day and death count data. Hints: note that the separator is one or more spaces. Make the argument <code>n</code> a value that limits the number of columns to the values in the 4 columns and the last column captures all the extra stuff. Then keep only the first four columns.</p>
<p>15. Now you are almost ready to finish. Add column names to the matrix, including one called <code>day</code>. Also, add a column with the month. Call the resulting object <code>dat</code>. Finally, make sure the day is an integer not a character. Hint: use only the first five columns.</p>
<p>16. Now finish it up by tidying <code>tab</code> with the <code>pivot_longer</code> function.</p>
<p>17. Make a plot of deaths versus day with color to denote year. Exclude 2018 since we do not have data for the entire year.</p>
<p>18. Now that we have wrangled this data step-by-step, put it all together in one R chunk, using the pipe as much as possible. Hint: first define the indexes, then write one line of code that does all the string processing.</p>
<p>19. Advanced: let’s return to the MLB Payroll example from the web scraping section. Use what you have learned in the web scraping and string processing chapters to extract the payroll for the New York Yankees, Boston Red Sox, and Oakland A’s and plot them as a function of time.</p>


</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><a href="https://www.regular-expressions.info/tutorial.html" class="uri">https://www.regular-expressions.info/tutorial.html</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a href="http://r4ds.had.co.nz/strings.html#matching-patterns-with-regular-expressions" class="uri">http://r4ds.had.co.nz/strings.html#matching-patterns-with-regular-expressions</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><a href="https://rstudio.github.io/cheatsheets/strings.pdf" class="uri">https://rstudio.github.io/cheatsheets/strings.pdf</a><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p><a href="https://rstudio.github.io/cheatsheets/strings.pdf" class="uri">https://rstudio.github.io/cheatsheets/strings.pdf</a><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p><a href="http://www.pnas.org/content/112/40/12349.abstract" class="uri">http://www.pnas.org/content/112/40/12349.abstract</a><a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p><a href="http://www.pnas.org/content/112/40/12349" class="uri">http://www.pnas.org/content/112/40/12349</a><a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p><a href="https://regexone.com/" class="uri">https://regexone.com/</a><a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("http:\/\/rafalab\.dfci\.harvard\.edu\/dsbook-part-1");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../wrangling/web-scraping.html" class="pagination-link" aria-label="Extracting data from the web">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Extracting data from the web</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../wrangling/text-analysis.html" class="pagination-link" aria-label="Text analysis">
        <span class="nav-page-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Text analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Introduction to Data Science was written by Rafael A. Irizarry</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/rafalab/dsbook-part-1/blob/main/wrangling/string-processing.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/rafalab/dsbook-part-1/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This book was built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>


</body></html>